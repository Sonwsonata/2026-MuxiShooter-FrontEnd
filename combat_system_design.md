# 战斗系统架构设计

## 一、系统概述

本设计文档基于fgoshooter游戏机制，为射击游戏实现完整的战斗系统。系统包含伤害计算、技能管理、弹幕发射、Buff效果等核心模块。

## 二、核心模块设计

### 2.1 伤害计算系统（DamageSystem）

**伤害公式**：
```
最终伤害 = (10 + 攻击力) × (1 + 图鉴攻击加成 + 所有伤害增加效果 - 所有伤害降低效果 + 其他效果)
         × [暴击时: (1 + 100% + 图鉴爆伤加成 + 其他爆伤加成)]
```

**实现要点**：
- 基础攻击力：10（固定）+ 玩家攻击力（可成长）
- 伤害增减：累加所有增伤/减伤效果
- 暴击判定：根据暴击率随机判定
- 暴击伤害：基础200%（1+100%）+ 额外爆伤加成

**数据结构**：
```javascript
{
  baseAttack: 10,           // 基础攻击力
  playerAttack: 0,          // 玩家攻击力
  codexBonus: 0,            // 图鉴加成
  damageIncrease: 0,        // 伤害增加
  damageDecrease: 0,        // 伤害降低
  critRate: 0,              // 暴击率
  critDamage: 1.0,          // 暴击伤害加成（基础100%）
  codexCritDamage: 0        // 图鉴爆伤加成
}
```

### 2.2 技能系统（SkillSystem）

**技能数据结构**：
```javascript
{
  id: 'laptop',                    // 技能ID
  name: '笔记本电脑',              // 技能名称
  type: 'active',                  // 技能类型：active/passive
  cd: 2,                           // 冷却时间（秒）
  duration: 0,                     // 持续时间（0表示瞬发）
  currentCd: 0,                    // 当前冷却
  level: 1,                        // 技能等级
  upgrades: [],                    // 已选择的强化
  
  // 技能效果配置
  effect: {
    bulletPattern: 'line',         // 弹幕模式
    bulletCount: 3,                // 弹幕数量
    bulletRows: 1,                 // 弹幕排数
    damageMultiplier: 3.0,         // 伤害倍率（300%）
    pierce: 0,                     // 穿透数量
    // ... 其他效果参数
  }
}
```

**技能列表**：
1. **笔记本电脑**：向前发射1排3个弹幕
2. **外卖**：持续期间在普攻两侧发射额外弹幕
3. **换鱼宝典**：向前发射横向5发弹幕
4. **电动车**：提升攻速和移速
5. **AI工具**：生成镜像同步攻击
6. **期末屠模式**：普攻必定暴击
7. **君子六艺**：随机发射大量弹幕

### 2.3 强化系统（UpgradeSystem）

**强化等级**：
- **铜色**（Bronze）：基础强化，提供数值增益
- **银色**（Silver）：高级强化，提供特殊效果
- **金色**（Gold）：稀有强化，提供独特机制

**强化选择规则**：
- 每次升级提供3个随机强化选项
- 强化与已拥有的技能相关
- 同一技能可以多次强化

**强化效果类型**：
- `cd_reduce`: 冷却时间减少
- `damage_increase`: 伤害增加
- `duration_increase`: 持续时间增加
- `crit_rate`: 暴击率增加
- `crit_damage`: 暴击伤害增加
- `pierce`: 穿透增加
- `bullet_count`: 弹幕数量增加
- `special`: 特殊效果

### 2.4 弹幕系统（BulletSystem）

**弹幕模式**：
- `line`: 直线发射（笔记本电脑）
- `side`: 两侧发射（外卖）
- `horizontal`: 横向扇形（换鱼宝典）
- `random`: 随机方向（君子六艺）
- `orbit`: 环绕旋转（后端-分布式集群）

**弹幕属性**：
```javascript
{
  x, y,                    // 位置
  vx, vy,                  // 速度向量
  damage,                  // 伤害
  pierce,                  // 剩余穿透次数
  critRate,                // 暴击率
  critDamage,              // 暴击伤害
  size,                    // 尺寸
  color,                   // 颜色
  sourceSkill,             // 来源技能
  alive                    // 存活状态
}
```

### 2.5 Buff系统（BuffSystem）

**Buff类型**：
- `attack_speed`: 攻速增益
- `move_speed`: 移速增益
- `crit_rate`: 暴击率增益
- `damage`: 伤害增益
- `guaranteed_crit`: 必定暴击
- `mirror`: 镜像效果

**Buff数据结构**：
```javascript
{
  id: 'buff_001',
  type: 'attack_speed',
  value: 1.0,              // 效果值（100%攻速）
  duration: 3,             // 持续时间
  remaining: 3,            // 剩余时间
  stackable: false,        // 是否可叠加
  source: 'electric_car'   // 来源技能
}
```

### 2.6 冷却管理系统（CooldownSystem）

**功能**：
- 管理所有技能的冷却时间
- 支持冷却减少效果
- 自动触发技能（当CD完成时）

**实现**：
```javascript
{
  skills: {
    'laptop': { cd: 2, current: 0, ready: true },
    'takeout': { cd: 10, current: 3.5, ready: false }
  },
  cdReduction: 0.08  // 全局CD减少8%
}
```

## 三、数据流设计

### 3.1 游戏状态（GameState）

```javascript
{
  // 玩家状态
  player: {
    x, y,
    hp, maxHp,
    attack,
    moveSpeed,
    fireRate
  },
  
  // 战斗数据
  combat: {
    bullets: [],
    enemies: [],
    damageStats: { /* 伤害计算参数 */ }
  },
  
  // 技能数据
  skills: {
    owned: [],           // 拥有的技能
    active: [],          // 激活中的技能
    cooldowns: {}        // 冷却状态
  },
  
  // Buff数据
  buffs: [],
  
  // 升级数据
  level: 1,
  exp: 0,
  expMax: 100
}
```

### 3.2 更新流程（Update Loop）

```
每帧更新：
1. 更新时间增量（dt）
2. 更新技能冷却
3. 检查并触发就绪的技能
4. 更新Buff效果
5. 更新弹幕位置
6. 更新敌人位置
7. 碰撞检测与伤害计算
8. 清理死亡对象
9. 渲染画面
```

## 四、技能实现细节

### 4.1 笔记本电脑

**基础效果**：
- 向前发射1排3个弹幕
- 基础倍率：300% × (2-3) = 600%-900%
- 冷却时间：2秒

**强化选项**：
- 豪华显示器：弹幕穿透+1
- 低耗模式：变为2排，伤害-20%
- "科学上网"：释放2次，CD+25%
- 固态硬盘（银）：穿透+1
- 机械键盘（银）：爆伤+50%
- 更新驱动（银）：第二次伤害+50%
- 磁盘清理（铜）：伤害+20%
- 校园网（铜）：CD-8%
- 快捷键（铜）：暴击率+8%

### 4.2 外卖

**基础效果**：
- 持续5秒，在普攻两侧发射弹幕
- 每侧每秒4发，共40发
- 基础倍率：100% × 2
- 冷却时间：10秒

**强化选项**：
- 外卖柜监控：每次发射2发，伤害-20%
- 轻量化饮食：弹幕向中心收束
- "搞劳"：每次发射2发，CD+40%
- 免配送费：外圈弹幕伤害+50%
- 精准起送（银）：频率+20%
- 下饭剧（银）：持续+8%
- 满减券（铜）：CD-8%
- 急送（铜）：伤害+20%
- 黑色液体勺（铜）：暴击率+5%

### 4.3 换鱼宝典

**基础效果**：
- 向前发射横向5发弹幕
- 基础倍率：100% × 5
- 冷却时间：3秒

**强化选项**：
- 换鱼雷达：范围增加
- 跑路：穿透+1，伤害-40%
- 脚所通走：范围进一步增加，CD+30%
- 消息免打扰：枪头弹幕伤害+50%
- ddl（银）：枪头弹幕伤害+30%
- 假装工作（银）：穿透伤害+20%
- 换鱼计时（铜）：CD-8%
- 喝水（铜）：伤害+20%
- 快速切屏（铜）：暴击率+8%

### 4.4 电动车

**基础效果**：
- 持续3秒，攻速+100%
- 冷却时间：10秒

**强化选项**：
- 神奇车牌：移速+50%
- 武汉交通：敌方移速-15%
- 识别码：变为常驻效果
- 头盔（银）：暴击率+5%
- 充电器（银）：持续+8%
- 充电桩（银）：CD-8%

### 4.5 AI工具

**基础效果**：
- 生成1个镜像，持续5秒
- 镜像同步攻击
- 冷却时间：20秒

**强化选项**：
- 一键润色：镜像+1，伤害-10%
- 深度思考：镜像+1，CD+20%
- "共创"（铜）：每个镜像提供15%伤害加成
- 免费额度（铜）：持续+8%
- 云端同步（铜）：镜像伤害+20%
- 提示词优化（铜）：CD-8%

### 4.6 期末屠模式

**基础效果**：
- 持续5秒，普攻必定暴击
- 冷却时间：15秒

**强化选项**：
- 小抄：爆伤+50%，CD+30%
- 求捞：效果对其他主动技生效，CD+25%
- 历年真题（金）：无视敌方减伤
- 网课（铜）：爆伤+30%
- 热带冰红茶（铜）：持续+8%
- PPT（铜）：CD-8%

### 4.7 君子六艺

**基础效果**：
- 持续5秒，随机发射25个弹幕
- 基础倍率：100%
- 冷却时间：10秒

**强化选项**：
- 麻：数量+100%，伤害-30%
- 孝：尺寸增大（+25%伤害），间隔增加
- 乐：常驻效果，禁用其他主动技，每个主动技增伤5%
- 忌（铜）：伤害+20%
- 蚌（铜）：间隔-20%
- 典（铜）：暴击率+5%

## 五、文件结构

```
src/game/
├── combat/
│   ├── damageSystem.js        # 伤害计算系统
│   ├── bulletSystem.js        # 弹幕系统（扩展）
│   ├── bulletPatterns.js      # 弹幕发射模式
│   └── combatManager.js       # 战斗管理器
├── skill/
│   ├── skillManager.js        # 技能管理器
│   ├── skillDefinitions.js    # 技能定义（7个技能）
│   ├── skillExecutor.js       # 技能执行器
│   └── cooldownManager.js     # 冷却管理器
├── buff/
│   ├── buffSystem.js          # Buff系统
│   └── buffTypes.js           # Buff类型定义
└── upgrade/
    ├── upgradeSystem.js       # 强化系统
    └── upgradeDefinitions.js  # 强化定义
```

## 六、实现优先级

**第一阶段（核心功能）**：
1. 伤害计算系统
2. 技能冷却管理
3. 基础技能实现（笔记本电脑、外卖、换鱼宝典）
4. 弹幕发射模式

**第二阶段（增强功能）**：
5. Buff系统
6. 高级技能实现（电动车、AI工具、期末屠模式、君子六艺）
7. 强化系统基础框架

**第三阶段（完善功能）**：
8. 所有强化选项实现
9. 特殊效果（镜像、穿透、必定暴击等）
10. 数值平衡调整

## 七、技术要点

### 7.1 性能优化
- 使用对象池管理弹幕和敌人
- 避免频繁的数组操作
- 使用空间分区优化碰撞检测

### 7.2 代码组织
- 模块化设计，职责分离
- 使用工厂模式创建技能和弹幕
- 使用策略模式处理不同的弹幕模式

### 7.3 可扩展性
- 技能配置数据驱动
- 强化效果可组合
- 易于添加新技能和新强化
